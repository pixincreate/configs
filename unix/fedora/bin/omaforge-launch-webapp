#!/bin/bash

browser=$(xdg-settings get default-web-browser 2>/dev/null)

# Check if browser is installed via Flatpak
is_flatpak() {
    grep -q "^Exec=.*flatpak run" {~/.local,/usr,/var/lib/flatpak/exports}/share/applications/"$browser" 2>/dev/null
}

# Determine flags based on browser type (strip .desktop suffix for matching)
case ${browser%.desktop} in
    *chrome*|*brave*|*edge*|*opera*|*vivaldi*|*chromium*|*helium*)
        flags="--incognito --app="
        ;;
    *firefox*|*zen*|*floorp*|*librewolf*)
        flags="-kiosk -private-window "
        ;;
    *)
        # Fallback to Brave Flatpak
        exec setsid flatpak run com.brave.Browser --incognito --app="$1" "${@:2}"
        ;;
esac

# Launch browser
if is_flatpak; then
    # Use browser name without .desktop suffix as app ID
    app_id="${browser%.desktop}"
    exec setsid flatpak run "$app_id" $flags"$1" "${@:2}"
else
    # Regular package - extract binary path
    browser_bin=$(sed -n 's/^Exec=\([^ ]*\).*/\1/p' {~/.local,/usr}/share/applications/"$browser" 2>/dev/null | head -1)
    exec setsid "$browser_bin" $flags"$1" "${@:2}"
fi
