#!/bin/bash

ICON_DIR="$HOME/.local/share/applications/icons"
DESKTOP_DIR="$HOME/.local/share/applications"

if [ "$#" -eq 0 ]; then
  echo "Finding installed web apps..."
  WEB_APPS=()

  while IFS= read -r -d '' file; do
    if grep -q '^Exec=.*omaforge-launch-\(webapp\|browser\).*' "$file"; then
      WEB_APPS+=("$(basename "${file%.desktop}")")
    fi
  done < <(find "$DESKTOP_DIR" -name '*.desktop' -print0 2>/dev/null)

  if [ ${#WEB_APPS[@]} -eq 0 ]; then
    echo "No web apps found to remove."
    exit 0
  fi

  IFS=$'\n' SORTED_WEB_APPS=($(sort <<<"${WEB_APPS[*]}"))
  unset IFS

  echo ""
  echo "Installed web apps:"
  for i in "${!SORTED_WEB_APPS[@]}"; do
    echo "$((i+1)). ${SORTED_WEB_APPS[$i]}"
  done
  echo ""

  read -p "Enter app names to remove (space-separated, or 'all'): " input

  if [ "$input" = "all" ]; then
    APP_NAMES=("${SORTED_WEB_APPS[@]}")
  else
    read -ra APP_NAMES <<< "$input"
  fi
else
  APP_NAMES=("$@")
fi

if [ ${#APP_NAMES[@]} -eq 0 ]; then
  echo "No apps selected for removal."
  exit 0
fi

for APP_NAME in "${APP_NAMES[@]}"; do
  DESKTOP_FILE="$DESKTOP_DIR/$APP_NAME.desktop"
  ICON_FILE="$ICON_DIR/$APP_NAME.png"

  if [ -f "$DESKTOP_FILE" ]; then
    rm -f "$DESKTOP_FILE"
    rm -f "$ICON_FILE"
    echo "✓ Removed $APP_NAME"
  else
    echo "✗ $APP_NAME not found"
  fi
done
