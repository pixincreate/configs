#!/bin/bash
# Interactive package management for macOS
# Add, remove, and search packages for Homebrew and Cask

set -euo pipefail

MACOS_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGES_DIR="$MACOS_PATH/packages"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_menu() {
    clear
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}   macOS Package Manager${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "1. Add package"
    echo "2. Remove package"
    echo "3. Search package"
    echo "4. List packages"
    echo "5. Exit"
    echo ""
    echo -ne "${YELLOW}Choose option: ${NC}"
}

list_package_files() {
    echo -e "\n${BLUE}Available package lists:${NC}"
    echo "1. brew.packages (CLI tools)"
    echo "2. cask.packages (GUI apps)"
    echo "3. Cancel"
    echo -ne "\n${YELLOW}Select package list: ${NC}"

    read -r choice
    case $choice in
        1) echo "$PACKAGES_DIR/brew.packages"; return 0 ;;
        2) echo "$PACKAGES_DIR/cask.packages"; return 0 ;;
        3) return 1 ;;
        *) echo -e "${RED}Invalid choice${NC}"; return 1 ;;
    esac
}

add_package() {
    local package_file
    package_file=$(list_package_files) || return

    echo -ne "\n${YELLOW}Enter package name: ${NC}"
    read -r package

    if [[ -z "$package" ]]; then
        echo -e "${RED}Package name cannot be empty${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    # Check if package already exists
    if grep -qx "$package" "$package_file" 2>/dev/null; then
        echo -e "${YELLOW}Package '$package' already exists in $(basename "$package_file")${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    # Check package availability
    local basename=$(basename "$package_file")
    if [[ "$basename" == "cask.packages" ]]; then
        echo -e "${BLUE}Searching Homebrew Cask...${NC}"
        if brew search --cask "$package" | grep -q "^$package$"; then
            echo "$package" >> "$package_file"
            echo -e "${GREEN}Added '$package' to $basename${NC}"
        else
            echo -e "${YELLOW}Package not found in Cask, adding anyway...${NC}"
            echo "$package" >> "$package_file"
        fi
    else
        echo -e "${BLUE}Searching Homebrew...${NC}"
        if brew search "$package" | grep -q "^$package$"; then
            echo "$package" >> "$package_file"
            echo -e "${GREEN}Added '$package' to $basename${NC}"
        else
            echo -e "${YELLOW}Package not found in Homebrew, adding anyway...${NC}"
            echo "$package" >> "$package_file"
        fi
    fi

    echo -ne "\n${YELLOW}Install now? (y/N): ${NC}"
    read -r install
    if [[ "$install" =~ ^[Yy]$ ]]; then
        if [[ "$basename" == "cask.packages" ]]; then
            brew install --cask "$package"
        else
            brew install "$package"
        fi
    fi

    read -p "Press Enter to continue..."
}

remove_package() {
    local package_file
    package_file=$(list_package_files) || return

    echo -ne "\n${YELLOW}Enter package name to remove: ${NC}"
    read -r package

    if [[ -z "$package" ]]; then
        echo -e "${RED}Package name cannot be empty${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    if grep -qx "$package" "$package_file" 2>/dev/null; then
        sed -i '' "/^$package$/d" "$package_file"
        echo -e "${GREEN}Removed '$package' from $(basename "$package_file")${NC}"

        echo -ne "\n${YELLOW}Uninstall package? (y/N): ${NC}"
        read -r uninstall
        if [[ "$uninstall" =~ ^[Yy]$ ]]; then
            local basename=$(basename "$package_file")
            if [[ "$basename" == "cask.packages" ]]; then
                brew uninstall --cask "$package"
            else
                brew uninstall "$package"
            fi
        fi
    else
        echo -e "${RED}Package '$package' not found in $(basename "$package_file")${NC}"
    fi

    read -p "Press Enter to continue..."
}

search_package() {
    echo -e "\n${BLUE}Package types:${NC}"
    echo "1. Homebrew (CLI tools)"
    echo "2. Cask (GUI apps)"
    echo "3. Both"
    echo -ne "\n${YELLOW}Choose type: ${NC}"
    read -r type

    echo -ne "${YELLOW}Enter search term: ${NC}"
    read -r search_term

    if [[ -z "$search_term" ]]; then
        echo -e "${RED}Search term cannot be empty${NC}"
        read -p "Press Enter to continue..."
        return
    fi

    case $type in
        1)
            echo -e "\n${BLUE}Searching Homebrew...${NC}"
            brew search "$search_term"
            ;;
        2)
            echo -e "\n${BLUE}Searching Homebrew Cask...${NC}"
            brew search --cask "$search_term"
            ;;
        3)
            echo -e "\n${BLUE}Searching Homebrew...${NC}"
            brew search "$search_term"
            echo -e "\n${BLUE}Searching Homebrew Cask...${NC}"
            brew search --cask "$search_term"
            ;;
        *)
            echo -e "${RED}Invalid choice${NC}"
            ;;
    esac

    read -p "Press Enter to continue..."
}

list_packages() {
    local package_file
    package_file=$(list_package_files) || return

    echo -e "\n${BLUE}Packages in $(basename "$package_file"):${NC}"
    grep -v '^#\|^$' "$package_file" | sort || echo -e "${YELLOW}No packages found${NC}"

    read -p "Press Enter to continue..."
}

main() {
    # Check if Homebrew is installed
    if ! command -v brew &>/dev/null; then
        echo -e "${RED}Homebrew is not installed!${NC}"
        echo -e "${YELLOW}Run ./macos-setup first${NC}"
        exit 1
    fi

    while true; do
        show_menu
        read -r choice

        case $choice in
            1) add_package ;;
            2) remove_package ;;
            3) search_package ;;
            4) list_packages ;;
            5) echo -e "\n${GREEN}Goodbye!${NC}"; exit 0 ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

main
